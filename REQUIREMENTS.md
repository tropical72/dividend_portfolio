# 배당 포트폴리오 관리기 - 요구사항 명세서 (v2.0 KivyMD Edition)

## 1. 개요

본 문서는 '배당 포트폴리오 관리기' 소프트웨어의 기능 및 비기능적 요구사항을 정의합니다. 본 프로그램은 사용자가 한국 및 미국 주식/ETF 시장의 관심 종목을 등록하고, 배당 정보를 기반으로 최적의 배당 투자 포트폴리오를 구성/관리하며, AI(Gemini/ChatGPT)를 통해 분석을 받는 크로스 플랫폼(Windows, Android) 애플리케이션입니다.

**핵심 가치:**
- **Cross-Platform:** Python Kivy/KivyMD를 사용하여 Windows 데스크톱과 Android 앱 환경을 모두 지원.
- **Clean Architecture:** Frontend(UI)와 Backend(Logic)를 완전히 분리하여 향후 Flutter 등으로의 UI 전환 용이성 확보.
- **Standalone:** 별도의 외부 서버 없이 로컬 환경에서 모든 데이터 처리 및 저장 수행.

## 2. 사용자 시나리오 (User Scenarios)

- **시나리오 1: 신규 사용자 (관심종목 등록 및 구성)**
  1. 사용자는 앱을 실행하고 'Watchlist' 화면에서 국가(US/KR)를 선택하고 티커(예: AAPL, 005930)를 입력하여 종목을 추가한다.
  2. 추가된 종목의 이름, 현재가, 배당률이 실시간(또는 캐시)으로 표시되는 것을 확인한다.
  3. 'Portfolio' 화면으로 이동하여 '고정인컴', '채권/현금 버퍼', '성장/배당성장' 카테고리를 확인한다.
  4. Watchlist에서 종목을 선택(데스크톱: 드래그, 모바일: 롱프레스 후 선택)하여 원하는 카테고리에 할당한다.
  5. 총 투자 금액과 종목별 비중(%)을 입력하고 계산 결과를 확인한다.

- **시나리오 2: 포트폴리오 관리 및 비교**
  1. 구성한 포트폴리오를 '은퇴 설계 A'라는 이름으로 저장한다.
  2. 'Comparison' 화면에서 저장된 여러 포트폴리오의 연간 배당금 흐름을 막대 그래프로 비교한다.
  3. 특정 포트폴리오를 선택하여 상세 내역을 확인하거나 다시 수정하기 위해 Portfolio 화면으로 불러온다.

- **시나리오 3: AI 분석 어드바이저**
  1. 'AI Advisor' 화면으로 이동하여 현재 구성된 포트폴리오에 대한 분석을 요청한다.
  2. "20년 후 월 500만원 배당이 목표입니다."와 같은 투자 목표를 입력한다.
  3. AI(Gemini 또는 ChatGPT)가 제안하는 포트폴리오 조정안과 추천 종목 리스트를 마크다운 형식으로 확인한다.

## 3. 주요 기능 요구사항

### 3.1. Watchlist 관리
- **종목 추가/삭제**: 티커 기반 추가, 중복 방지, 유효성 검사.
- **데이터 표시**: Ticker, Name, Price, Annual Yield, 1-Yr Return, Last Ex-Div Date 등.
- **영속성**: `data/watchlist.json`에 저장.

### 3.2. 포트폴리오 관리 (FE/BE 분리 핵심)
- **카테고리 시스템**: 고정인컴, 채권/현금 버퍼, 성장/배당성장 3단계 분류.
- **비중 설정**: 합계 100% 검증 및 시각적 피드백(빨간색/녹색).
- **통화 환산**: 실시간 환율을 반영하여 USD/KRW 동시 표시.
- **저장/불러오기**: `data/portfolios.json`에 카테고리 구조를 포함하여 저장.

### 3.3. 시뮬레이션 및 시각화
- **계산 방식 선택**: '과거 이력 기반(Historical)' vs '공시 연 배당률 기반(Yield-based)'.
- **Historical 로직**: 각 지급월의 마지막 배당액을 대표값으로 인정하여 연간 총액 산출.
- **그래프**: 월별 예상 배당금 흐름을 막대 그래프로 표시.

### 3.4. AI 어드바이저
- **멀티 모델 지원**: Gemini 및 ChatGPT API 선택 가능.
- **대화 맥락 유지**: 슬라이딩 윈도우 방식을 적용하여 이전 대화 내용 기억.
- **영속성**: `data/chat_history.json`에 대화 기록 저장.

### 3.5. 설정 (Settings)
- API 키 관리(Gemini, OpenAI, DART), 기본 투자 목표 설정, 프롬프트 템플릿 수정.

## 4. 기술적 요구사항 (Non-Functional)

### 4.1. 아키텍처: Clean Architecture
- **Frontend (src/frontend)**:
  - Kivy / KivyMD 프레임워크 사용.
  - UI 렌더링, 사용자 이벤트 핸들링 전담.
  - Backend의 API(클래스/함수)를 호출하여 데이터 수신.
- Backend (src/backend):
  - **Pure Python** (UI 의존성 0%).
  - 데이터 수집(`yfinance`, `OpenDartReader`), 계산 로직, 파일 I/O.
  - 외부 API(Gemini, Frankfurter) 통신.
  - 추후 Flutter 전환 시 Dart로 포팅하거나 Python 엔진으로 임베딩 가능한 구조.

### 4.2. 다국어 지원 (Internationalization)
- **지원 언어**: 한국어(KO), 영어(EN)를 우선 지원한다.
- **리소스 분리**: 모든 UI 텍스트 문자열은 코드와 분리된 별도의 리소스 파일(예: JSON 또는 Python Dictionary)로 관리해야 한다.
- **언어 감지**: 앱 최초 실행 시 시스템 언어를 감지하여 자동 설정하되, 설정 메뉴에서 사용자가 수동으로 변경할 수 있어야 한다.

### 4.3. 데이터 및 성능
- **비동기 처리**: 네트워크 요청 시 UI 프리징 방지를 위해 `threading` 또는 `asyncio` 사용.
- **캐싱**: 주가/배당 데이터는 1일간 로컬 캐시 사용.

### 4.4. 환경 대응
- Windows 및 Android 환경에서 파일 경로 이슈가 없도록 `pathlib` 기반 상대 경로 관리.